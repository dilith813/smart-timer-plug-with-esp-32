// ESP32 Countdown Timer with Firebase Sync, Captive Portal, and Reset Logic
// Full final integrated sketch

#include <WiFi.h>
#include <WiFiManager.h>
#include <FirebaseESP32.h>
#include <ESPAsyncWebServer.h>
#include <AsyncTCP.h>
#include <EEPROM.h>
#include <U8g2lib.h>
#include <AiEsp32RotaryEncoder.h>
#include <ArduinoJson.h>

// OLED
U8G2_SSD1306_128X64_NONAME_F_HW_I2C u8g2(U8G2_R0);

// Firebase
FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;
String userEmail, userPassword, userId;
String basePath = "/users";
String plugId = "plug1"; // Hardcoded
String fullPath;

// Rotary Encoder
#define clk 18
#define dt 19
#define sw 23
AiEsp32RotaryEncoder rotaryEncoder(clk, dt, sw);

// Output and Reset Pin
#define OUTPUT_PIN 5
#define RESET_PIN 27

// Timer variables
byte hours, minutes, seconds;
unsigned long totalSeconds = 0;
bool timerRunning = false;
bool isPaused = false;

// WiFiManager
WiFiManager wm;

// Flags
bool firebaseReady = false;
bool portalRequired = false;
bool isDeletedFlag = false;

void firebaseWrite(String key, int value) {
  String path = fullPath;
  path += "/"; 
  path += key;
  Firebase.setInt(fbdo, path, value);
}

void firebaseWriteBool(String key, bool value) {
  String path = fullPath;
  path += "/";
  path += key;
  Firebase.setBool(fbdo, path, value);
}

void firebaseWriteString(String key, String value) {
  String path = fullPath;
  path += "/";
  path += key;
  Firebase.setString(fbdo, path, value);
}

void firebaseLogin() {
  config.api_key = ""; // Not used in email/password
  auth.user.email = userEmail;
  auth.user.password = userPassword;
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);

  Serial.println("Logging in...");
  while (!auth.token.uid.length()) {
    delay(500);
    Serial.print(".");
  }
  userId = String(auth.token.uid.c_str());
  fullPath = basePath;
  fullPath += "/";
  fullPath += userId;
  fullPath += "/plugs/";
  fullPath += plugId;
  firebaseReady = true;
  Serial.println("\nFirebase login successful.");
}

bool checkIsDeletedFromFirebase() {
  String path = fullPath;
  path += "/isDeleted";
  if (Firebase.getBool(fbdo, path)) {
    return fbdo.boolData();
  }
  return false;
}

void streamCallback(StreamData data) {
  if (data.dataPath() == "/isDeleted" && data.boolData()) {
    portalRequired = true;
  }
  if (data.dataPath() == "/isPaused") {
    isPaused = data.boolData();
  }
  if (data.dataPath() == "/durationSeconds") {
    totalSeconds = data.intData();
  }
  if (data.dataPath() == "/isOn") {
    timerRunning = data.boolData();
  }
}

void streamTimeoutCallback(bool timeout) {
  if (timeout) {
    Serial.println("Firebase stream timeout. Attempting reconnect.");
    Firebase.beginStream(fbdo, fullPath);
  }
}

void firebaseStartStream() {
  String path = fullPath;
  Firebase.setStreamCallback(fbdo, streamCallback, streamTimeoutCallback);
  Firebase.beginStream(fbdo, path);
}

void launchCaptivePortal() {
  wm.resetSettings();

  WiFiManagerParameter custom_email("email", "Email", "", 40);
  WiFiManagerParameter custom_pass("password", "Password", "", 40);
  WiFiManagerParameter custom_name("plugname", "Plug Name", plugId.c_str(), 20);

  wm.addParameter(&custom_email);
  wm.addParameter(&custom_pass);
  wm.addParameter(&custom_name);

  if (!wm.autoConnect("Plug_Config")) {
    Serial.println("Failed to connect. Restarting...");
    delay(3000);
    ESP.restart();
  }

  userEmail = custom_email.getValue();
  userPassword = custom_pass.getValue();
  plugId = custom_name.getValue();
  fullPath = basePath;
  fullPath += "/";
  fullPath += userId;
  fullPath += "/plugs/";
  fullPath += plugId;

  Serial.println("WiFi connected via portal.");
  Serial.print("SSID: "); Serial.println(WiFi.SSID());
  Serial.print("Email: "); Serial.println(userEmail);

  EEPROM.begin(512);
  EEPROM.writeString(0, userEmail);
  EEPROM.writeString(50, userPassword);
  EEPROM.writeString(100, plugId);
  EEPROM.commit();
}

void loadCredentials() {
  EEPROM.begin(512);
  userEmail = EEPROM.readString(0);
  userPassword = EEPROM.readString(50);
  plugId = EEPROM.readString(100);
}

void setup() {
  Serial.begin(115200);
  u8g2.begin();
  pinMode(OUTPUT_PIN, OUTPUT);
  pinMode(RESET_PIN, INPUT_PULLUP);

  loadCredentials();

  // Check reset pin
  if (digitalRead(RESET_PIN) == LOW) {
    portalRequired = true;
    Serial.println("Reset pin LOW → portal required");
  }

  // Attempt WiFi connection
  WiFi.begin();
  unsigned long startTime = millis();
  while (WiFi.status() != WL_CONNECTED && millis() - startTime < 10000) {
    delay(500);
    Serial.print(".");
  }
  if (WiFi.status() != WL_CONNECTED) {
    portalRequired = true;
    Serial.println("WiFi failed → portal required");
  }

  if (!portalRequired) {
    firebaseLogin();
    isDeletedFlag = checkIsDeletedFromFirebase();
    if (isDeletedFlag) {
      Serial.println("Plug marked deleted → portal required");
      portalRequired = true;
    }
  }

  if (portalRequired) {
    launchCaptivePortal();
    ESP.restart();
  }

  // Ready
  firebaseStartStream();
}

void loop() {
  static unsigned long lastTick = millis();
  if (firebaseReady && timerRunning && !isPaused && totalSeconds > 0) {
    if (millis() - lastTick >= 1000) {
      lastTick = millis();
      totalSeconds--;

      firebaseWrite("timeRemaining", totalSeconds);
      if (totalSeconds == 0) {
        digitalWrite(OUTPUT_PIN, LOW);
        firebaseWriteBool("isOn", false);
      }
    }
  }
  delay(10); // don't cook the CPU
}
