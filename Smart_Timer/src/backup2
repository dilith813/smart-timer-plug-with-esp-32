// Full Final Code: ESP32 Countdown Timer with Firebase + OLED + Captive Portal + Rotary Encoder + Reset Pin + Full UI

#include <WiFi.h>
#include <WiFiManager.h>
#include <FirebaseESP32.h>
#include <EEPROM.h>
#include <U8g2lib.h>
#include <AiEsp32RotaryEncoder.h>

// --- OLED Setup ---
U8G2_SSD1306_128X64_NONAME_F_HW_I2C u8g2(U8G2_R0);

// --- Rotary Encoder Pins ---
#define clk 18
#define dt 19
#define sw 23
AiEsp32RotaryEncoder rotaryEncoder(clk, dt, sw);

// --- Output & Reset Pins ---
#define OUTPUT_PIN 5
#define RESET_PIN 27

// --- Firebase Setup ---
FirebaseData fbdo;
FirebaseAuth auth;
FirebaseConfig config;
String userEmail, userPassword, userId;
String basePath = "/users";
String plugId = "plug1";
String fullPath;
bool firebaseReady = false;

// --- Timer State ---
byte hours1, hours2, minutes1, minutes2, seconds1, seconds2;
int counter = 0, current_menu = 0, current_pos = 0;
bool pause_selected = false, text = true, sw_state = false;
unsigned long totalSeconds = 0, lastSecond = 0;

// --- Reset/Captive Portal Flag ---
bool portalRequired = false;

// --- WiFi Manager ---
WiFiManager wm;

// --- Encoder ISR ---
void IRAM_ATTR readEncoderISR() {
  rotaryEncoder.readEncoder_ISR();
}

void loadCredentials() {
  EEPROM.begin(512);
  userEmail = EEPROM.readString(0);
  userPassword = EEPROM.readString(50);
  plugId = EEPROM.readString(100);
}

void saveCredentials() {
  EEPROM.begin(512);
  EEPROM.writeString(0, userEmail);
  EEPROM.writeString(50, userPassword);
  EEPROM.writeString(100, plugId);
  EEPROM.commit();
}

void firebaseLogin() {
  auth.user.email = userEmail;
  auth.user.password = userPassword;
  config.api_key = "AIzaSyBv--LTAWwKUKwZeXPRXsJOiGF_22tDEIQ";
  config.database_url = "smarttimerplug-default-rtdb.firebaseio.com";
  Firebase.begin(&config, &auth);
  Firebase.reconnectWiFi(true);
  while (!auth.token.uid.length()) {
    delay(500);
    Serial.print(".");
  }
  userId = auth.token.uid.c_str();
  fullPath = basePath; 
  fullPath += "/";
  fullPath += userId;
  fullPath += "/plugs/";
  fullPath += plugId;
  firebaseReady = true;
  String path = fullPath.c_str();
  path += String("/plugName");
  Firebase.setString(fbdo, path, plugId);
}

void firebaseWrite(String key, int value) {
  if (!firebaseReady) return;
  String path = fullPath;
  path += String("/");
  path += key;
  Firebase.setInt(fbdo, path.c_str(), value);
}

void firebaseWriteBool(String key, bool value) {
  if (!firebaseReady) return;
  String path = fullPath;
  path += String("/");
  path += key;
  Firebase.setBool(fbdo, path.c_str(), value);
}

void launchCaptivePortal() {
  WiFiManagerParameter custom_email("email", "Email", "", 40);
  WiFiManagerParameter custom_pass("password", "Password", "", 40);
  WiFiManagerParameter custom_name("plugname", "Plug Name", plugId.c_str(), 20);
  wm.addParameter(&custom_email);
  wm.addParameter(&custom_pass);
  wm.addParameter(&custom_name);
  wm.resetSettings();
  if (!wm.autoConnect("Plug_Config")) ESP.restart();
  userEmail = custom_email.getValue();
  userPassword = custom_pass.getValue();
  plugId = custom_name.getValue();
  saveCredentials();
}

void setup() {
  Serial.begin(115200);
  u8g2.begin();
  u8g2.setFont(u8g2_font_fub20_tr);
  pinMode(OUTPUT_PIN, OUTPUT);
  pinMode(RESET_PIN, INPUT_PULLUP);

  rotaryEncoder.begin();
  rotaryEncoder.setup(readEncoderISR);
  rotaryEncoder.setBoundaries(-1000, 1000, false);
  rotaryEncoder.setAcceleration(0);

  loadCredentials();
  if (digitalRead(RESET_PIN) == LOW) portalRequired = true;
  WiFi.begin();
  unsigned long startTime = millis();
  while (WiFi.status() != WL_CONNECTED && millis() - startTime < 8000) {
    delay(500);
  }
  if (WiFi.status() != WL_CONNECTED) portalRequired = true;
  if (portalRequired) {
    launchCaptivePortal();
    ESP.restart();
  }
  firebaseLogin();
  
}

void resetTimer() {
  current_menu = 0;
  counter = 0;
  current_pos = 0;
  text = true;
  pause_selected = false;
  sw_state = 0;
  hours1 = hours2 = 0;
  minutes1 = minutes2 = 0;
  seconds1 = seconds2 = 0;
  totalSeconds = 0;
  digitalWrite(OUTPUT_PIN, LOW);
}

void loop() {
  int raw = rotaryEncoder.readEncoder();
  sw_state = rotaryEncoder.isEncoderButtonDown();
  u8g2.clearBuffer();

  if (current_menu == 0) {
    u8g2.drawStr(10, 25, "Set Hours");
    u8g2.setCursor(40, 60);
    u8g2.printf("%d_", counter);
    if (sw_state) {
      hours1 = counter;
      counter = 0;
      current_menu = 1;
    }
  } else if (current_menu == 1) {
    u8g2.drawStr(10, 25, "Hours 2");
    u8g2.setCursor(40, 60);
    u8g2.printf("%d%d_", hours1, counter);
    if (sw_state) {
      hours2 = counter;
      counter = 0;
      current_menu = 2;
    }
  } else if (current_menu == 2) {
    u8g2.drawStr(10, 25, "Minutes");
    u8g2.setCursor(40, 60);
    u8g2.printf("%d_", counter);
    if (sw_state) {
      minutes1 = counter;
      counter = 0;
      current_menu = 3;
    }
  } else if (current_menu == 3) {
    u8g2.drawStr(10, 25, "Minutes 2");
    u8g2.setCursor(40, 60);
    u8g2.printf("%d%d_", minutes1, counter);
    if (sw_state) {
      minutes2 = counter;
      counter = 0;
      current_menu = 4;
    }
  } else if (current_menu == 4) {
    u8g2.drawStr(10, 25, "Seconds");
    u8g2.setCursor(40, 60);
    u8g2.printf("%d_", counter);
    if (sw_state) {
      seconds1 = counter;
      counter = 0;
      current_menu = 5;
    }
  } else if (current_menu == 5) {
    u8g2.drawStr(10, 25, "Seconds 2");
    u8g2.setCursor(40, 60);
    u8g2.printf("%d%d_", seconds1, counter);
    if (sw_state) {
      seconds2 = counter;
      hours1 = constrain(hours1, 0, 2);
      hours2 = constrain(hours2, 0, (hours1 == 2 ? 3 : 9));
      totalSeconds = ((hours1 * 10 + hours2) * 3600UL) + ((minutes1 * 10 + minutes2) * 60UL) + (seconds1 * 10 + seconds2);
      firebaseWrite("timeRemaining", totalSeconds);
      firebaseWriteBool("isOn", true);
      current_menu = 6;
      lastSecond = millis();
      digitalWrite(OUTPUT_PIN, HIGH);
    }
  } else if (current_menu == 6) {
    int h = totalSeconds / 3600;
    int m = (totalSeconds % 3600) / 60;
    int s = totalSeconds % 60;
    char buf[10];
    sprintf(buf, "%02d:%02d:%02d", h, m, s);
    u8g2.drawStr(20, 20, buf);

    u8g2.setFont(u8g2_font_7x14_tr);
    u8g2.drawStr(0, 40, "Reset  Resume  Pause");
    int selected = abs(counter) % 3;
    u8g2.drawFrame(selected * 42, 40, 42, 20);

    if (!pause_selected && millis() - lastSecond >= 1000 && totalSeconds > 0) {
      lastSecond += 1000;
      totalSeconds--;
      firebaseWrite("timeRemaining", totalSeconds);
    }
    if (sw_state) {
      switch (selected) {
        case 0:
          resetTimer();
          firebaseWriteBool("isOn", false);
          firebaseWrite("timeRemaining", 0);
          firebaseWriteBool("isPaused", false);
          break;
        case 1:
          pause_selected = false;
          firebaseWriteBool("isPaused", false);
          break;
        case 2:
          pause_selected = true;
          firebaseWriteBool("isPaused", true);
          break;
      }
    }
    if (totalSeconds == 0) {
      digitalWrite(OUTPUT_PIN, LOW);
      firebaseWriteBool("isOn", false);
      current_menu = 0;
    }
  }
  u8g2.sendBuffer();
  delay(50);
}

if (isPaused && !pause_selected) {
    Serial.println("Pausing via app.");
    pause_selected = true;
  }
  if (!isPaused && pause_selected && totalSeconds > 0) {
    Serial.println("Resuming via app.");
    pause_selected = false;
  }
  if (!isOn && current_menu == 4) {
    Serial.println("Turned off via app.");
    reset();
  }
  if (isOn && current_menu != 4 && totalSeconds > 0) {
    Serial.println("Starting timer via app.");
    current_menu = 4;
    digitalWrite(p_out, HIGH);
  }